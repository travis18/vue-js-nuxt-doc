<link rel="stylesheet" href="assets/style.css" type="text/css" />
# 8. Using Vuex

åœ¨å‰é¢å…©å€‹ç« ç¯€ä¸­ï¼Œæˆ‘å€‘å­¸åˆ°äº† Nuxt æä¾›äº† `asyncData` hook ä¾†è®“ Axios åœ¨çµ„å»ºè¼‰å…¥å‰åŸ·è¡Œ server æˆ– client ç«¯å‘¼å«ã€‚ä½ å¯èƒ½å·²ç¶“çŸ¥é“ï¼Œåœ¨æ‡‰ç”¨ç¨‹å¼æˆé•·å£¯å¤§çš„éç¨‹ï¼Œåˆ©ç”¨ Vuex store ç®¡ç† state æœƒè®Šå¾—è¶Šä¾†è¶Šé‡è¦ã€‚åœ¨é€™å€‹ç« ç¯€ä¸­æˆ‘å€‘æœƒä¾†å„ªåŒ–åŸæœ¬çš„ç¨‹å¼ç¢¼ï¼Œå…ˆå¾æ•´ç† API å‘¼å«ï¼Œå°‡å®ƒå€‘é›†ä¸­æˆç‚ºä¸€å€‹ Service æœå‹™ï¼Œç„¶å¾Œå†ç‚ºæˆ‘å€‘çš„ event æ´»å‹•å»ºç«‹ Vuex æ¨¡çµ„ã€‚

## å»ºç«‹ Event Service

è¦å»ºç«‹çµ¦ Event å°ˆç”¨çš„ Serviceï¼Œé¦–å…ˆæˆ‘å€‘è¦å…ˆä¾†åœ¨æ ¹ç›®éŒ„ä¸­é–‹ä¸€å€‹å«åš `/services` çš„è³‡æ–™å¤¾ï¼Œç„¶å¾Œåœ¨è£¡é¢å»ºç«‹åƒä¸‹é¢é€™æ¨£çš„æ–°æª”æ¡ˆ

ğŸ“ƒ **/services/EventService.js**

```javascript
import axios from 'axios'
    
    const apiClient = axios.create({
      baseURL: `http://localhost:3000`,
      withCredentials: false, 
      headers: {
        Accept: 'application/json',
        'Content-Type': 'application/json'
      }
    })
    
    export default {
      getEvents() {
        return apiClient.get('/events')
      },
      getEvent(id) {
        return apiClient.get('/events/' + id)
      }
    }
```

åœ¨é€™å€‹æª”æ¡ˆä¸­æˆ‘å€‘è¨­å®šäº† Axios ä¸¦ä¸”å»ºç«‹äº†å…©å€‹ method ä¾†å‘¼å« APIã€‚é€™å…©å€‹ method éƒ½æœƒå›å‚³ promiseã€‚ä¹‹å¾Œå°±å¯ä»¥å¾ˆç°¡å–®çš„åœ¨é é¢çµ„å»ºåˆ©ç”¨é€™å…©å€‹ method å–å¾— Event æ´»å‹•è³‡è¨Šã€‚

ğŸ“ƒ **/pages/_id.vue**

```javascript
    ...
    <script>
    import EventService from '@/services/EventService.js' // <----
    
    export default {
      ...
      async asyncData({ error, params }) {
        try {
          const { data } = await EventService.getEvent(params.id)
          ...
```

åœ¨ä¿®æ”¹éå¾Œï¼Œå¾ç€è¦½å™¨çœ‹èµ·ä¾†æ‡‰è©²æ˜¯è·Ÿä¹‹å‰å®Œå…¨ä¸€æ¨£ï¼Œåªæ˜¯æˆ‘å€‘çš„ç¨‹å¼ç¢¼å·²ç¶“ä¿®æ”¹çš„æ›´åŠ æ¨¡çµ„åŒ–äº†ã€‚

## åœ¨ Nuxt ä¸­è¨­å®šä½ çš„ Vuex ä¾†

åœ¨æˆ‘å€‘ä½¿ç”¨ `create-nuxt-app` å»ºç«‹ Nuxt æ‡‰ç”¨ç¨‹å¼è…³æ‰‹æ¶æ™‚åŒæ™‚æœƒå»ºç«‹æ•¸å€‹è³‡æ–™å¤¾ã€‚å…¶ä¸­ä¸€å€‹æ˜¯ `store` è³‡æ–™å¤¾ï¼Œé€™ä¹Ÿæ˜¯æˆ‘å€‘ Vuex ç›¸é—œçš„ç¨‹å¼ç¢¼æœƒæ”¾ç½®çš„åœ°æ–¹ã€‚

å¦‚æœ Nuxt åµæ¸¬åˆ°é€™å€‹ `store` è³‡æ–™å¤¾å­˜åœ¨æ™‚ï¼Œå®ƒæœƒè‡ªå‹• import Vuex åˆ°ä½ çš„å°ˆæ¡ˆï¼Œè€Œä¸” `store` é¸é …ä¹Ÿæœƒè¢«åŠ å…¥åˆ°åº•å±¤ Vue å¯¦é«”ä¸­ã€‚é è¨­æ¯å€‹åœ¨ `store` è³‡æ–™å¤¾è£¡é¢çš„ `.js` æª”æœƒè½‰åŒ–ç‚ºå¸¶æœ‰å‘½åç©ºé–“ namespace çš„æ¨¡çµ„ã€‚

æˆ‘å€‘æ¥è‘—æœƒåœ¨ `store` ç›®éŒ„ä¸­å»ºç«‹ä¸€å€‹ `events.js` çš„ Vuex æ¨¡çµ„ã€‚Nuxt ä¹Ÿæœƒç‚ºæˆ‘å€‘å»ºç«‹ä¸€å€‹å‘½åç©ºé–“ç‚º `events` çš„ Vuex æ¨¡çµ„ã€‚è€Œé€™å€‹æ¨¡çµ„å°‡æœƒè¢«ç”¨ä¾†å‘¼å« API ä¸¦ä¸”å°‡ event æ´»å‹•è³‡æ–™å„²å­˜åˆ° state è£¡é¢ã€‚çœ‹èµ·ä¾†æœƒåƒæ˜¯ä¸‹é¢é€™æ¨£ã€‚

![](assets/Ch08/01.jpg)

è£¡é¢çš„ç¨‹å¼ç¢¼çœ‹èµ·ä¾†æœƒåƒæ˜¯ä¸‹é¢é€™æ¨£ï¼š

ğŸ“ƒ **/store/events.js**

```javascript
    import EventService from '@/services/EventService.js'
    export const state = () => ({
      events: []
    })
    export const mutations = {
      SET_EVENTS(state, events) {
        state.events = events
      }
    }
    export const actions = {
      fetchEvents({ commit }) {
        return EventService.getEvents().then(response => {
          commit('SET_EVENTS', response.data)
        })
      }
    }
```


é€™é‚Šç­†è¨˜ä¸€ä¸‹ï¼Œ`state` å€¼**æ°¸é è¦æ˜¯ä¸€å€‹** `function` ä»¥é¿å…ç™¼ç”Ÿä¸æƒ³è¦çš„ server ç«¯åˆ†äº« *state*ã€‚å¦ä¸€ä»¶è¦éŠ˜è¨˜åœ¨å¿ƒçš„æ˜¯æˆ‘å€‘å¿…é ˆå¾ `fetchEvents` action å›å‚³ä¸€å€‹ *promise*ã€‚é€™å¯ä»¥å¹«åŠ©æˆ‘å€‘çš„çµ„ä»¶çŸ¥é“ *promise* ä»€éº¼æ™‚å€™è§£æ±ºï¼Œé€™æ¨£æ‰èƒ½ç¹¼çºŒè¼‰å…¥é é¢ã€‚

ä¸‹ä¸€æ­¥å¯ä»¥åˆ©ç”¨æˆ‘å€‘ `index.vue` çµ„ä»¶è£¡é¢çš„ Vuex æ¨¡çµ„ï¼Œä½†æˆ‘å€‘å¾—å…ˆå­¸ç¿’å¦ä¸€å€‹ Nuxt çµ¦æˆ‘å€‘çš„é é¢çµ„ä»¶é‰¤å­(hookï¼‰ã€‚`fetch` é é¢çµ„ä»¶é‰¤å­(hook)æ˜¯åœ¨ client å’Œ server ç«¯é‹ä½œï¼Œåœ¨é é¢æ¸²æŸ“å‰å¡«å…¥ store è³‡æ–™ã€‚ä¸åƒ `asyncData` ï¼Œå®ƒæ²’æœ‰æˆ‘å€‘ä¸å†éœ€è¦çš„åˆä½µçµ„ä»¶è³‡æ–™å›å‚³å€¼ã€‚

ğŸ“ƒ **/pages/index.vue**

```javascript
    <script>
    import EventCard from '@/components/EventCard.vue'
    import { mapState } from 'vuex'  // <--- To map event
    export default {
      ...
      async fetch({ store, error }) {
        try {
          await store.dispatch('events/fetchEvents')
        } catch (e) {
      ...
      },
      computed: mapState({
        events: state => state.events.events
      })
    }
    </script>
```

ç¾åœ¨æˆ‘å€‘å¯ä»¥ç”¨ Vuex ä¾†åˆ—å‡ºæ‰€æœ‰çš„ event æ´»å‹•äº†ã€‚

![](assets/Ch08/02.gif)

## ç‚º EventShow é é¢åŠ ä¸Š Vuex

ç¾åœ¨æˆ‘å€‘ä¾†ç‚ºå¦ä¸€å€‹ç”¨ä¾†è¼‰å…¥å–®ä¸€æ´»å‹•çš„é é¢çµ„ä»¶åŠ å…¥ Vuexã€‚å…ˆåœ¨ **events** Vuex æ¨¡çµ„ä¸­åŠ å…¥æ–°çš„ç¨‹å¼ç¢¼

ğŸ“ƒ **/store/events.js**

```javascript
    import EventService from '@/services/EventService.js'
    export const state = () => ({
      events: [],
      event: {}
    })
    export const mutations = {
      ...
      SET_EVENT(state, event) {
        state.event = event
      }
    }
    export const actions = {
      ...
      fetchEvent({ commit }, id) {
        return EventService.getEvent(id).then(function(response) {
          commit('SET_EVENT', response.data)
        })
      }
    }
```

å†ä¾†æˆ‘å€‘åªè¦å†æ›´æ–° **id** çµ„ä»¶å°±å¥½å›‰ï¼Œé †ä¾¿å†åŠ å…¥ä¸€äº›æ¨£æ¿å’Œæ¨£å¼çš„ç¨‹å¼ç¢¼

ğŸ“ƒ **/pages/event/_id.vue**

```html
    <template>
      <div>
        <div class="event-header">
          <span class="eyebrow">
            @{{ event.time }} on {{ event.date }}
          </span>
          <h1 class="title">
            {{ event.title }}
          </h1>
          <h5>Organized by {{ event.organizer ? event.organizer.name : '' }}</h5>
          <h5>Category: {{ event.category }}</h5>
        </div>
    
        <span name="map">
          <h2>Location</h2>
        </span>
    
        <address>{{ event.location }}</address>
    
        <h2>Event details</h2>
        <p>{{ event.description }}</p>
    
        <h2>
          Attendees
          <span class="badge -fill-gradient">
            {{ event.attendees ? event.attendees.length : 0 }}
          </span>
        </h2>
        <ul class="list-group">
          <li v-for="(attendee, index) in event.attendees" :key="index" class="list-item">
            <b>{{ attendee.name }}</b>
          </li>
        </ul>
      </div>
    </template>
    <script>
    import { mapState } from 'vuex'
    export default {
      ...
      async fetch({ store, params, error }) {
        try {
          await store.dispatch('event/fetchEvent', params.id)
        } catch (e) {
          error({
            statusCode: 503,
            message: 'Unable to fetch event #' + params.id
          })
        }
      },
      computed: mapState({
        event: state => state.events.event
      })
    }
    </script>
    
    <style scoped>
    .prompt-box {
      position: relative;
      overflow: hidden;
      padding: 1em;
      margin-bottom: 24px;
      transform: scaleY(1);
    }
    .prompt-box > .title {
      margin: 0 0 0.5em;
    }
    .prompt-box > .title > .meta {
      margin-left: 10px;
    }
    .prompt-box > .actions {
      display: flex;
      align-items: center;
    }
    .prompt-box > button {
      margin-right: 0.5em;
    }
    .prompt-box > button:last-of-type {
      margin-right: 0;
    }
    .location {
      margin-bottom: 0;
    }
    .location > .icon {
      margin-left: 10px;
    }
    .event-header > .title {
      margin: 0;
    }
    .list-group {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .list-group > .list-item {
      padding: 1em 0;
      border-bottom: solid 1px #e5e5e5;
    }
    </style>
```

ç¾åœ¨æˆ‘å€‘åœ¨ç€è¦½æ´»å‹•åˆ—è¡¨å’Œæ´»å‹•å…§å®¹ï¼Œéƒ½æ˜¯ä½¿ç”¨ Vuex å›‰ï½

![](assets/Ch08/03.gif)

## è¤‡ç¿’

åœ¨é€™å€‹ç« ç¯€ä¸­ï¼Œæˆ‘å€‘é‡æ§‹äº† Axios API å‘¼å«ï¼ŒæŠŠå®ƒæ•´åˆåˆ° EventService æ¨¡çµ„è£¡é¢ï¼Œç„¶å¾Œä¹Ÿå»ºç«‹äº† Events Vuex æ¨¡çµ„ä¾†å‘¼å« EventServiceï¼Œæœ€è¿‘åˆ©ç”¨ Nuxt çš„ `fetch` é‰¤å­(hook)ï¼Œåˆ†æ´¾ actionï¼Œä¾†å–å¾— events çš„ stateã€‚







