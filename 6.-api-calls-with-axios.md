<link rel="stylesheet" href="assets/style.css" type="text/css" />
# 6. å‘¼å« APIï¼šä½¿ç”¨ Axios

å› ç‚ºæˆ‘å€‘å‰µå»ºçš„æ˜¯ Universal æ‡‰ç”¨ç¨‹å¼ï¼Œæ‰€ä»¥åœ¨å‘¼å« API çš„æ™‚å€™æœƒç¨å¾®ä¸ä¸€æ¨£ã€‚åœ¨é€™å€‹ç« ç¯€æˆ‘å€‘å¯ä»¥å­¸åˆ°è¦æ€éº¼è¨­ç½®å¥½ä¸€å€‹ç”¨ä¾†è·‘ API å‘¼å«çš„ dummy è³‡æ–™åº«ï¼Œå­¸åˆ°å¦‚ä½•ç”¨ `Axios` åŠ `Promise` å¯«æˆ‘å€‘çš„ä¸€å€‹ API å‘¼å«ï¼Œæœ€å¾Œé‚„æœ‰è¦ä¾†è¨­ç½®å¥½é©ç•¶çš„éŒ¯èª¤è™•ç†ã€‚

## API æ˜¯åœ¨å“ªè£¡è¢«å‘¼å«çš„æï¼Ÿ

ç¾åœ¨è®“æˆ‘å€‘ä¾†çœ‹çœ‹ï¼Œç•¶è¼‰å…¥ä¸€å€‹çµ„ä»¶è³‡æ–™çš„æ™‚å€™ï¼ŒAPI æ˜¯æ€éº¼è¢«å‘¼å«çš„ã€‚
ä¸‹é¢æ˜¯åœ¨åˆå§‹åŒ–è¼‰å…¥çš„æ™‚å€™æ‰€ç™¼ç”Ÿçš„äº‹æƒ…ã€‚

![](assets/Ch06/01.jpg)

ç„¶å¾Œä¸€æ—¦ Vue èµ·ä¾†äº†ï¼ŒAPI å‘¼å«æœƒå¾ client ç«¯é€™é‚Šé–‹å§‹ã€‚

![](assets/Ch06/02.jpg)

æ‰€ä»¥æˆ‘å€‘éœ€è¦å°‡ API å‘¼å«å¯«åœ¨æˆ‘å€‘çµ„ä»¶ä¸­çš„æ–¹æ³•ï¼Œè€Œé€™å€‹æ–¹æ³•åœ¨ server ç«¯å’Œ client ç«¯éƒ½å¯ä»¥é‹ä½œï¼Œæ„Ÿè¦ºè¦åŒæ™‚æ»¿è¶³é€™å…©å€‹æ¢ä»¶æœƒå¾ˆæ£˜æ‰‹ã€‚å¥½åœ¨ Nuxt åˆå†æ¬¡è§£æ•‘äº†æˆ‘å€‘ï¼ˆUniversal æ¨¡å¼ï¼‰ã€‚

## è¨­ç½®ï¼šä¸€å€‹çµ¦ App ç”¨çš„æ¨¡æ“¬ API

ç‚ºäº†è¦é–‹å§‹æŠ“è³‡æ–™ä¸¦é¡¯ç¤ºæ´»å‹• Eventï¼Œé¦–å…ˆæˆ‘å€‘éœ€è¦ä¸€å€‹çµ¦æˆ‘å€‘ app ç”¨çš„ APIã€‚

æˆ‘å€‘æœƒéœ€è¦ `json-server`ï¼Œæœ‰äº†ä»–æˆ‘å€‘å°±å¯ä»¥å¾ˆå¿«çš„å‰µå»ºä¸€å€‹æ¨¡æ“¬ API è€Œä¸ç”¨è¨­å®šä»€éº¼éº»ç…©çš„ä¼ºæœå™¨ã€‚

åœ¨é–‹å§‹å®‰è£ä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆä¾†æŠŠæœƒå›å‚³çš„ JSON è³‡æ–™å¯«åˆ°ä¸€å€‹æª”æ¡ˆè£¡é¢ã€‚ç„¶å¾ŒæŠŠæª”æ¡ˆæ”¾åˆ°æ‡‰ç”¨ç¨‹å¼çš„æ ¹ç›®éŒ„ä¸‹é¢ã€‚

**JSON è³‡æ–™å¦‚ä¸‹**
```javascript
{
  "events": [
    {
      "id": 5928101,
      "user": {
        "id": "abc123",
        "name": "Adam"
      },
      "category": "animal welfare",
      "organizer": "Adam",
      "title": "Cat Cabaret",
      "description": "Yay felines!",
      "location": "Meow Town",
      "date": "2019-01-03T21:54:00.000Z",
      "time": "2:00",
      "attendees": []
    },  
    {
      "id": 8419988,
      "user": {
        "id": "abc123",
        "name": "Adam"
      },
      "category": "animal welfare",
      "organizer": "Adam",
      "title": "Kitty Cluster",
      "description": "Yay cats!",
      "location": "Catlandia",
      "date": "2019-01-31T22:09:00.000Z",
      "time": "7:00",
      "attendees": []
    },
    {
      "id": 4582797,
      "user": {
        "id": "abc123",
        "name": "Adam"
      },
      "category": "animal welfare",
      "organizer": "Adam",
      "title": "Puppy Parade",
      "description": "Yay pups!",
      "location": "Puptown ",
      "date": "2019-02-02T23:27:00.000Z",
      "time": "1:00",
      "attendees": []
    }
  ]
}
```

æ¥ä¸‹ä¾†å°±æ˜¯æŠŠ JSON server æŠ“ä¸‹ä¾†å®‰è£è·‘èµ·ä¾†ã€‚ä¸‹é¢æ˜¯å®‰è£æŒ‡ä»¤ï¼š

```
npm install -g json-server
```

å†ä¾†å°±æ˜¯æŠŠé€™å€‹å‰›å®‰è£å¥½çš„ server çµ¦å«èµ·ä¾†ï¼š

```
json-server --watch db.json
```

ç•¶ server æˆåŠŸè·‘èµ·ä¾†ä¹‹å¾Œä½ æœƒçœ‹åˆ°ï¼š

```shell
    \{^_^}/ hi!
        
    Loading db.json
    Done
        
    Resources
    http://localhost:3000/events
        
    Home
    http://localhost:3000
        
    Type s + enter at any time to create a snapshot of the database
    Watching...
```

å¦‚æœç¾åœ¨åˆ°ç€è¦½å™¨ä¸Šç€è¦½ç¶²å€ `http://localhost:3000/events` çš„è©±ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ´»å‹• event ä»¥ json æ ¼å¼å‘ˆç¾åœ¨ç€è¦½å™¨ä¸Šé¢ã€‚

é è¨­ä¾†èªªï¼Œæˆ‘å€‘çš„ Nuxt app åœ¨é–‹ç™¼ç‹€æ…‹æœƒå•Ÿå‹•åœ¨ port 3000ï¼Œ ä½†æ˜¯ç¾åœ¨æˆ‘å€‘é–‹çš„ `json-server` ä¹Ÿæ˜¯ port 3000ï¼Œç‚ºäº†ä¸è®“å…©å€‹ server æ’ portï¼Œæˆ‘å€‘å¾—æŠŠ Nuxt app é–‹åœ¨å¦å¤–ä¸€å€‹ port ï¼Œæ–¹æ³•æ˜¯åœ¨å•Ÿå‹• dev server çš„æ™‚å€™åŠ ä¸€å€‹åƒæ•¸ï¼š

```shell
PORT=3001 npm run dev
```

é€™æ¨£ Nuxt æ‡‰ç”¨ç¨‹å¼å°±æœƒé–‹åœ¨ port 3001 ä¸Šé¢ï¼Œ`json-server` API å¯ä»¥ç¹¼çºŒåœ¨ port 3000 ä¸Šé¢è·‘ã€‚

## è¨­ç½®ï¼šå®‰è£ç”¨ä¾†å‘¼å« API çš„ Axios

Axio æ˜¯ Nuxt ä¸Šç†æƒ³çš„ HTTP å‡½å¼åº«ã€‚Nuxt çš„ä¸»è¦ç›®çš„æ˜¯ç”¨ä¾†ç°¡å–®çš„å‰µå»º Universal æ¨¡å¼çš„ JavaScript appï¼Œè€Œ Axios å‰‡æ˜¯æŠŠè£½ä½œ server åŠ browser ç«¯çš„ HTTP è«‹æ±‚è®Šå¾—ç°¡å–®ã€‚

å†æœ€å‰é¢çš„ç« ç¯€ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ `create-nuxt-app` å‰µå»º app çš„æ™‚å€™ï¼Œå°±å·²ç¶“åœ¨ Nuxt å®‰è£äº† Axios æ¨¡çµ„ã€‚

å¦‚æœæ²’æœ‰åœ¨ä¸€é–‹å§‹å°±å®‰è£ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹é€™å€‹æŒ‡ä»¤å°±å¯ä»¥æŠŠå®ƒå®‰è£åˆ°ä½ çš„å°ˆæ¡ˆä¸­ï¼š

```shell
npm install @nuxtjs/axios
```

åŸ·è¡Œå®Œä¹‹å¾Œï¼Œæ‰“é–‹ `nuxt.config.js` æª”ç„¶å¾ŒåŠ å…¥é€™å¹¾è¡Œï¼š

*nuxt.config.js*

```javascript
  module.exports = {
    modules: [
      '@nuxtjs/axios',
    ]
  }
```

è«‹æ³¨æ„æˆ‘å€‘ä¸æ˜¯å®‰è£ Axiosï¼Œè€Œæ˜¯ Nuxt Axios æ¨¡çµ„ã€‚é€™å€‹æ¨¡çµ„æœ‰ä¸€å †é¡å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚èªªåƒæ˜¯ï¼š

- åœ¨åš HTTP è«‹æ±‚çš„æ™‚å€™æ•´åˆäº† Nuxt.js é€²åº¦æ¢
- æ•´åˆäº† Proxy æ¨¡çµ„
- è‡ªå‹•ä»¥ axios-retry é‡æ–°ç™¼å‡º HTTP è«‹æ±‚

é‚„æœ‰æ›´å¤§å †çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥åƒè€ƒå®˜æ–¹çš„ [Github é é¢](https://github.com/nuxt-community/axios-module)

## ğŸ›‘ å•é¡Œï¼šè©²æ€éº¼å»æŠ“æˆ‘å€‘çš„æ´»å‹•åˆ—è¡¨ EventListï¼Ÿ

æˆ‘å€‘æƒ³è¦åœ¨ `/pages/index.vue` è£¡å‘¼å« API æŠ“å‡ºæ‰€æœ‰æ´»å‹• event åˆ—è¡¨åˆ°å‰ç«¯é é¢ã€‚é¦–å…ˆå¦‚æœ HTTP è«‹æ±‚çš„æ˜¯æ´»å‹• event åˆ—è¡¨ï¼Œå°±åœ¨ server ç«¯æŠ“ï¼Œå¦‚æœè¦å°è¦½åˆ°æ´»å‹• event è©³ç´°è³‡æ–™é é¢å°±åœ¨ client ç«¯æŠ“æ´»å‹• event è³‡æ–™ã€‚

é‚£éº¼æˆ‘å€‘è¦æ€éº¼å‘¼å« API ä¾†æŠ“æ´»å‹• event è³‡æ–™å‘¢ï¼Ÿå’Œ Vue.js å®Œå…¨ä¸åŒçš„æ˜¯ï¼Œæˆ‘å€‘ä¸æœƒç”¨åˆ° `created()` é€™å€‹ç”Ÿå‘½é€±æœŸé‰¤å­(hook)ã€‚Nuxt ç‚ºæˆ‘å€‘çš„ `pages` è³‡æ–™å¤¾ä¸­çš„çµ„ä»¶é¡å¤–çš„é‰¤å­(hook)ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š

## è§£æ±ºæ–¹æ¡ˆï¼šNuxt çš„ asyncData

`asyncData` æœƒåœ¨æ¯æ¬¡è¼‰å…¥ **page** çµ„ä»¶ä¹‹å‰è¢«å‘¼å«ï¼Œæ‰€è¬‚ **page** çµ„ä»¶æŒ‡çš„æ˜¯æ”¾åœ¨ `pages` è³‡æ–™å¤¾è£¡é¢çš„çµ„ä»¶ã€‚åœ¨ç¬¬ä¸€æ¬¡ Nuxt app è«‹æ±‚çš„æ™‚å€™é€²è¡Œ server ç«¯å‘¼å«ï¼Œå°è¦½åˆ°æ›´é€²ä¸€æ­¥è·¯ç”±çš„æ™‚å€™é€²è¡Œ client ç«¯å‘¼å«ã€‚é€™å€‹æ–¹æ³•æ¥æ”¶ [context](https://nuxtjs.org/api/context) ç‚ºç¬¬ä¸€å€‹åƒæ•¸ï¼Œå¯ä»¥è¢«ç”¨ä¾†æŠ“å–æŸäº›è³‡æ–™ï¼ˆå¾ APIï¼‰ï¼Œç„¶å¾Œ Nuxt æœƒå°‡å›å‚³å€¼æ­é…çµ„ä»¶è³‡æ–™åˆä½µèµ·ä¾†ã€‚

é€™å€‹ `context` åƒæ•¸è®“ä½ å­˜å–å„ç¨®å±¬æ€§ï¼Œæ¯”å¦‚èªª `app`ï¼Œ`$axios`ï¼Œ`params`ï¼Œ`route`ï¼Œ`error`ç­‰ç­‰ã€‚åœ¨å‰ä¸€å€‹ç« ç¯€æˆ‘å€‘ç”¨ `context` ç‰©ä»¶æŠ“è·¯ç”±åƒæ•¸ã€‚åœ¨é€™å€‹ç« ç¯€æˆ‘å€‘å‰‡æ˜¯ç”¨å®ƒä¾†ä½¿ç”¨ **axios**ã€‚


## æ“·å–è³‡æ–™çµ¦æˆ‘å€‘çš„æ´»å‹• event åˆ—è¡¨

åœ¨å‰ä¸€å€‹ç« ç¯€ä¸­æˆ‘å€‘åœ¨ `pages` æ ¹ç›®éŒ„ä¸‹é¢çš„ `index.vue` é é¢ä¸­å‰µå»ºäº†ä¸€å€‹æ´»å‹• event é é¢ã€‚æˆ‘å€‘ä¾†è©¦è©¦çœ‹ç”¨è£¡é¢çš„ `asyncData` ä¾†æŠ“è³‡æ–™ã€‚

```javascript
  <script>
    export default {
      ...
      asyncData(context) {
        return context.$axios.get('http://localhost:3000/events').then(response => {
          return {
            events: response.data
          }
        })
      }
    }
  </script>
```

å¦‚ä½ æ‰€è¦‹ï¼Œæˆ‘å€‘å¾ `context` è£¡ç”¨ `$axios` ç‰©ä»¶ç„¶å¾Œé€²è¡Œ `get` è«‹æ±‚ã€‚é€™å€‹è«‹æ±‚æœƒå›å‚³ä¸€å€‹ `promise`ï¼Œç„¶å¾Œæˆ‘å€‘å†ä½¿ç”¨ `then` åœ¨ `promise` å›å‚³æ™‚æŒ‡å®šè¦è·‘ä»€éº¼ç¨‹å¼ç¢¼ã€‚è€Œåœ¨é€™å€‹ä¾‹å­æˆ‘å€‘æœƒå›å‚³åŒ…å« `events` çš„ç‰©ä»¶ï¼Œå®ƒæœƒåˆä½µåˆ°æˆ‘å€‘çš„çµ„ä»¶è³‡æ–™ã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ ES6 çš„è§£æ§‹èªæ³•ä¾†ç°¡åŒ–ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š

```javascript
    <script>
    export default {
      ...
      asyncData({ $axios }) {
        return $axios.get('http://localhost:3000/events').then(response => {
          return {
            events: response.data
          }
        })
      }
    }
    </script>
```

è«‹æ³¨æ„æˆ‘å€‘æ€éº¼çµæ§‹ `context` ç‰©ä»¶ï¼Œåªå»è™•è£¡é¢æˆ‘å€‘æƒ³è¦çš„ `$axios` æ¨¡çµ„ã€‚`{ $axios }`ï¼Œå°±æ˜¯æŠŠæƒ³è¦çš„ç‰©ä»¶/æ¨¡çµ„æ”¾åœ¨ `{}`è£¡é¢ï¼Œè¶…éä¸€å€‹çš„è©±å°±ç”¨ `,` éš”é–‹ã€‚

é€™å€‹æ™‚å€™å›å»çœ‹çœ‹ç€è¦½å™¨ï¼Œç„¶å¾Œç”¨ Vue Dev Tools æª¢æŸ¥ä¸€ä¸‹å°±å¯ä»¥çœ‹åˆ°è³‡æ–™éƒ½è¼‰å…¥äº†ã€‚

![](assets/Ch06/03.jpg)

## æ¸²æŸ“æ´»å‹• Event åˆ—è¡¨

åœ¨å‰é¢çš„ç« ç¯€æˆ‘å€‘æŠŠæœ‰é—œæ´»å‹• event åˆ—è¡¨çš„ç¨‹å¼ç¢¼éƒ½æ”¾åˆ° `page`çµ„ä»¶è£¡é¢å»æ¸²æŸ“ç•«é¢ã€‚ä½† Vue çš„ç¾å¥½ä¹‹è™•å°±åœ¨æ–¼ä½ å¯ä»¥æŠŠç¨‹å¼ç¢¼æ•´ç†åˆ°å„ç¨®çµ„ä»¶è£¡é¢å»ã€‚å› æ­¤æˆ‘å€‘ç¾åœ¨ä¾†å‰µå»ºä¸€å€‹**EventCard**çµ„ä»¶ä¾†é¡¯ç¤ºæˆ‘å€‘çš„æ¯å€‹æ´»å‹• eventï¼š

ğŸ“ƒ **/components/EventCard.vue**

```javascript
    <template>
      <nuxt-link :to="'/event/' + event.id">
        <div class="-shadow">
          <span class="eyebrow">
            @{{ event.time }} on {{ parsedDate }}
          </span>
          <h4 class="title">
            {{ event.title }}
          </h4>
          <span>{{ event.attendees.length }} attending</span>
        </div>
      </nuxt-link>
    </template>
    <script>
    export default {
      name: 'EventCard',
      props: {
        event: Object
      },
      computed: {
        parsedDate() {
          const eventDate = new Date(this.event.date)
          return eventDate.toDateString()
        }
      }
    }
    </script>
    <style scoped>
    div {
      padding: 20px;
      margin-bottom: 24px;
      transition: all 0.2s linear;
      cursor: pointer;
    }
    div:hover {
      transform: scale(1.01);
      box-shadow: 0 3px 12px 0 rgba(0, 0, 0, 0.2), 0 1px 15px 0 rgba(0, 0, 0, 0.19);
    }
    .title {
      margin: 0;
      color: black;
    }
    a {
      text-decoration: none;
    }
    </style>
```

ç„¶å¾Œæˆ‘å€‘ä¾†æŠŠåŸä¾† `pages/index.vue` è£¡é¢çš„ç¨‹å¼ç¢¼æ”¹æˆç”¨ **EventCard** çµ„ä»¶ä¾†é¡¯ç¤ºæ´»å‹• event åˆ—è¡¨ã€‚

ğŸ“ƒ **/pages/index.vue**

```javascript
    <template>
      <div>
        <h1>Events</h1>
        <EventCard
          v-for="(event, index) in events"
          :key="index"
          :event="event"
          :data-index="index"
        />
      </div>
    </template>
    <script>
    import EventCard from '@/components/EventCard.vue'
    export default {
      head() {
        return {
          title: 'Event Listing'
        }
      },
      asyncData({ $axios }) {
        return $axios.get('http://localhost:3000/events').then(response => {
          return {
            events: response.data
          }
        })
      },
      components: {
        EventCard
      }
    }
    </script>
```

æ”¹å¥½å¾Œåˆ°ç€è¦½å™¨çœ‹çœ‹çµæœï¼Œæ´»å‹• event åˆ—è¡¨å‡ºä¾†å•¦ï½

![](assets/Ch06/04.jpg)

## éŒ¯èª¤è™•ç†

å¦‚æœæˆ‘å€‘æŠŠ API server é—œæ‰ç„¶å¾Œå†å›åˆ°ç€è¦½å™¨ï¼Œæœƒçœ‹åˆ°ä»¥ä¸‹çš„éŒ¯èª¤è¨Šæ¯ï¼š

![](assets/Ch06/05.jpg)

é€™æ¨£é‚„ä¸å¤ ç†æƒ³ï¼Œæˆ‘å€‘æ‡‰è©²å¯ä»¥å†æ•æ‰(catch)é€™å€‹éŒ¯èª¤ç„¶å¾Œé¡¯ç¤ºæ›´å¥½æ›´æ°ç•¶çš„è¨Šæ¯ã€‚

```javascript
      asyncData({ $axios, error }) {
        return $axios.get('http://localhost:3000/events').then(response => {
          return {
            events: response.data
          }
        }).catch(e => {
          error({ statusCode: 503, message: 'Unable to fetch events at this time, please try again' })
        })
      },
```

æ³¨æ„å–”ï¼Œæˆ‘å€‘æŠŠ `error` ç‰©ä»¶åŒ…å«é€²ä¾†ï¼Œé€™æ¨£å°±å¯ä»¥åœ¨ `catch` å€å¡Šä½¿ç”¨ä¸Šå€‹ç« ç¯€å‰µå»ºçš„éŒ¯èª¤é é¢ã€‚åœ¨ç€è¦½å™¨ä¸Šçœ‹èµ·ä¾†æœƒåƒæ˜¯é€™æ¨£ï¼š

![](assets/Ch06/06.jpg)

æ˜¯ä¸æ˜¯å¥½å¤šæƒ¹ï¼

## è¤‡ç¿’

åœ¨é€™å€‹ç« ç¯€ä¸­æˆ‘å€‘å­¸æœƒäº†è¨­ç½®æ¨¡æ“¬çš„ API serverï¼Œä¸¦ä¸”å­¸åˆ°è¦æ€éº¼ç”¨ Nuxt Axios æ¨¡çµ„ä¸­åŠ åˆ° page çµ„ä»¶çš„ `asyncData` é‰¤å­ï¼ˆhookï¼‰ã€‚ç„¶å¾Œä¹ŸåŠ ä¸Šé©ç•¶çš„éŒ¯èª¤è™•ç†è®“è™•ç†éŒ¯èª¤é é¢çµ„ä»¶å¯ä»¥ä½¿ç”¨ã€‚



































